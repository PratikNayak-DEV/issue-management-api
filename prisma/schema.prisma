// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organization model (Tenant)
model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users  User[]
  issues Issue[]

  @@map("organizations")
}

// User model
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  role           Role
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdIssues     Issue[]       @relation("IssueCreator")
  assignedIssues    Issue[]       @relation("IssueAssignee")
  performedActivities ActivityLog[]

  @@index([organizationId])
  @@map("users")
}

// Issue model
model Issue {
  id             String      @id @default(uuid())
  title          String
  description    String?
  status         IssueStatus @default(OPEN)
  priority       String?
  organizationId String
  createdById    String
  assigneeId     String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User          @relation("IssueCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignee     User?         @relation("IssueAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  activities   ActivityLog[]

  @@index([organizationId])
  @@index([createdById])
  @@index([assigneeId])
  @@map("issues")
}

// Activity Log model
model ActivityLog {
  id           String       @id @default(uuid())
  issueId      String
  actionType   ActivityType
  oldValue     String?
  newValue     String?
  performedBy  String
  performedAt  DateTime     @default(now())

  issue       Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  performedByUser User  @relation(fields: [performedBy], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@map("activity_logs")
}

// Enums
enum Role {
  ADMIN
  MEMBER
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ActivityType {
  STATUS_CHANGED
  ASSIGNEE_CHANGED
  CREATED
  UPDATED
  DELETED
}
